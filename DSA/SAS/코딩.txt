libname DSAB 'E:\DSA 4기\SQL 학습\행복중심생협 데이터\데이터';

/*1. 매장별 고객 수*/

proc sql inobs=100;
	create table DSAB.cust_cnt as 
	select distinct shop_cd
						, count(client_no) as count
	from DSAB.tr
	group by shop_cd
;
quit;


/*2-1. 매장별 거래건수*/

proc sql inobs=100;
	create table DSAB.shop_sale_cnt as
	select distinct shop_cd, count(sale_date) as sale_count
	from DSAB.tr
	group by shop_cd
;
quit;


/*2-2. 고객별 거래건수*/

proc sql inobs=100;
	create table DSAB.cust_sale_cnt as
	select distinct client_no, sale_date, count(sale_date) as sale_count
	from DSAB.tr
	group by client_no
;
quit;

/*3-1. 매장별 매출액*/

proc sql inobs=100;
	create table DSAB.shop_tot_amt as
		select shop_cd, sum(buy_amt) as total_amt
	from DSAB.tr
	group by shop_cd
;
quit;

/*3-2. 고객별 매출액*/

proc sql inobs=100;
	create table DSAB.cust_tot_amt as
		select client_no, sum(buy_amt) as total_amt
	from DSAB.tr
	group by client_no
;
quit;

/*3-3. 매장별 고객별 매출액*/

proc sql inobs=100;
	create table DSAB.tot_amt as
		select shop_cd, client_no, sum(buy_amt) as total_amt
	from DSAB.tr
	group by shop_cd, client_no
;
quit;

/*4. 매장별 객단가*/

proc sql ;
	create table avg_price as
		select goods_cd, avg(sale_price) as avg_sale_price
	from DSAB.goods_new
;
quit;

proc sql inobs=100;
	create table avg_Qty as
		select goods_cd, sum(buy_qty)/count(client_no) as avg_cust_qty
	from DSAB.tr
;
quit;

/*****안돼ㅠㅠㅠ******/

proc sql inobs=100;
	create table cust_trans as
		select *
	from avg_price as a1
	left join
	(select * from avg_Qty) as a2
	on a1.goods_cd = a2.goods_cd
;
quit;


/*5. 고객별 상품선호도*/

proc sql inobs=100;
	create table goods_like as
		select client_no, goods_cd, count(goods_cd) as goods_cnt
	from DSAB.tr
	group by client_no, goods_cd
	having goods_cnt ^=1
;
quit; 


/*최근 6개월 활동회원----------어려워...*/

proc sql inobs=100;
	create table cust_6 as
		select client_no, sale_date 
	from DSAB.tr
	where  <= dt <= 20171031 
;
quit;
year(sale_date) as year, month(sale_date) as month;

/****intnx test****/
data tst;
	input dat;
*	format dat yymmdd10.;
	cards;
	20180425
	20180423
	;
run;
data tst;
	set tst;
	last= max(dat);
run;

/**6. 요일선호***/
proc sql inobs=100;
	create table week_like as
		select cust_id
			,case when weekday(sale_date) =1 then '일요일'
						when weekday(sale_date) =2 then '월요일'
						when weekday(sale_date) =3 then '화요일'
						when weekday(sale_date) =4 then '수요일'
						when weekday(sale_date) =5 then '목요일'
						when weekday(sale_date) =6 then '금요일'
						when weekday(sale_date) =7 then '토요일'
				end as week format = $6.
			,count(client_id) as week_cnt
			,sum(sale_price) as week_amt
	from DSAB.tr
	group by client_id, week
	order by client_id, week_cnt desc, week_amt desc
;
quit;


/**